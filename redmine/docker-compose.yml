version: "3"
services:
  redmine:
    image: redmine:latest
    depends_on:
      - postgres
    restart: always
    expose:
      - 3000
    environment:
      VIRTUAL_HOST: "${REDMINE_HOSTNAME}"
      VIRTUAL_PORT: 3000
      NGINX_PROXY_PASS_HEADERS: "proxy_set_header CLIENT_IP $$remote_addr;"
      LETSENCRYPT_HOST: "${REDMINE_HOSTNAME}"
      LETSENCRYPT_EMAIL: "${LETSENCRYPT_EMAIL}"
      REDMINE_DB_POSTGRES: "${DB_POSTGRES_HOST}"
      REDMINE_DB_DATABASE: "${DB_NAME}"
      REDMINE_DB_USERNAME: "${DB_USER}"
      REDMINE_DB_PASSWORD: "${DB_PASS}"
    volumes:
      - ./files:/usr/src/redmine/files
      - ./log:/usr/src/redmine/log
      - ./plugins:/usr/src/redmine/plugins
      - ./themes:/usr/src/redmine/public/themes
      - ./config/configuration.yml:/usr/src/redmine/config/configuration.yml
      - ./config/secret.yml:/usr/src/redmine/config/secret.yml

  postgres:
    image: postgres:9.6
    restart: always
    environment:
      POSTGRES_DB: "${DB_NAME}"
      POSTGRES_USER: "${DB_USER}"
      POSTGRES_PASSWORD: "${DB_PASS}"
    volumes:
      - ./postgres_data:/var/lib/postgresql/data

networks:
  default:
    external:
      name: ${NETWORK}
